# PL/SQL æ–°äººæ³¨æ„äº‹é¡¹ã€å¸¸è§é”™è¯¯ä¸Žé¢è¯•é—®é¢˜

> æœ¬ç« ä½œä¸º **PL/SQL æ•™ç¨‹çš„æ”¶å®˜ç« èŠ‚**ï¼Œä¸å†æ–°å¢žè¯­æ³•ï¼Œè€Œæ˜¯ç³»ç»Ÿæ€»ç»“ï¼š
>
> * æ–°äººæœ€å®¹æ˜“è¸©çš„å‘
> * é¡¹ç›®ä¸­æœ€å¸¸è§ã€æœ€å±é™©çš„é”™è¯¯
> * é¢è¯•ä¸­ **çœŸæ­£ä¼šè¢«é—®åˆ°ã€å¹¶åŒºåˆ†æ°´å¹³çš„é¢˜ç›®**
>
> è¿™ä¸€ç« çš„ç›®æ ‡åªæœ‰ä¸€ä¸ªï¼š
>
> ðŸ‘‰ **è®©æ–°äººå°‘çŠ¯é”™ã€è®©é¢è¯•å›žç­”â€œåƒåšè¿‡é¡¹ç›®çš„äººâ€**ã€‚

---

## 1. æ–°äººæœ€å®¹æ˜“æ··æ·†çš„æ ¸å¿ƒè®¤çŸ¥

### 1.1 æŠŠ PL/SQL å½“æˆâ€œå¢žå¼ºç‰ˆ SQLâ€

âŒ é”™è¯¯è®¤çŸ¥ï¼š

> SQL ä¸å¤Ÿå¼ºï¼Œæ‰€ä»¥ç”¨ PL/SQL æ¥è¡¥

âœ… æ­£ç¡®è®¤çŸ¥ï¼š

* SQLï¼š**é›†åˆè¿ç®—ã€æ•°æ®å¤„ç†**
* PL/SQLï¼š**æµç¨‹æŽ§åˆ¶ã€ç»„ç»‡ SQL**

ðŸ“Œ åŽŸåˆ™ï¼š

> **èƒ½ç”¨ä¸€æ¡ SQL è§£å†³çš„ï¼Œç»ä¸ç”¨ PL/SQL å¾ªçŽ¯**

---

### 1.2 å¿½è§† SQL ä¸Ž PL/SQL çš„ä¸Šä¸‹æ–‡åˆ‡æ¢

âŒ å¸¸è§å†™æ³•ï¼š

```plsql
for r in (select * from big_table) loop
  update big_table set ... where id = r.id;
end loop;
```

é—®é¢˜ï¼š

* æ€§èƒ½æžå·®

âœ… æ­£ç¡®æ–¹å‘ï¼š

* BULK COLLECT + FORALL

---

## 2. æ–°äººé«˜é¢‘è‡´å‘½é”™è¯¯ï¼ˆé¡¹ç›®çº§ï¼‰

### 2.1 åžå¼‚å¸¸ï¼ˆæœ€å±é™©ï¼‰

âŒ é”™è¯¯ç¤ºä¾‹ï¼š

```plsql
exception
  when others then
    null;
```

åŽæžœï¼š

* é”™è¯¯è¢«éšè—
* æ•°æ®ä¸ä¸€è‡´
* æ— æ³•æŽ’æŸ¥ç”Ÿäº§äº‹æ•…

âœ… æ­£ç¡®åŽŸåˆ™ï¼š

* å·²çŸ¥å¼‚å¸¸æ˜Žç¡®å¤„ç†
* æœªçŸ¥å¼‚å¸¸å¿…é¡»æŠ›å‡º

---

### 2.2 é”™è¯¯çš„ COMMIT ä½ç½®

âŒ é”™è¯¯ç¤ºä¾‹ï¼š

```plsql
for i in 1..1000 loop
  update ...;
  commit;
end loop;
```

é—®é¢˜ï¼š

* æ€§èƒ½å·®
* æ•°æ®éš¾ä»¥å›žæ»š

âœ… æ­£ç¡®åšæ³•ï¼š

* æ‰¹é‡å¤„ç†åŽç»Ÿä¸€ COMMIT
* æˆ– LIMIT åˆ†æ‰¹ COMMIT

---

### 2.3 åœ¨åœ¨çº¿äº‹åŠ¡ä¸­è®© PL/SQL COMMIT

âŒ åœºæ™¯ï¼š

* Java + Spring è°ƒç”¨å­˜å‚¨è¿‡ç¨‹
* å­˜å‚¨è¿‡ç¨‹å†…éƒ¨ COMMIT

åŽæžœï¼š

* Java äº‹åŠ¡å¤±æ•ˆ
* æ•°æ®å‡ºçŽ°â€œåŠæˆåŠŸâ€

âœ… åŽŸåˆ™ï¼š

> **åœ¨çº¿äº‹åŠ¡ä¸­ï¼ŒCOMMIT æ°¸è¿œç”± Java æŽ§åˆ¶**

---

### 2.4 NULL åˆ¤æ–­é”™è¯¯

âŒ é”™è¯¯å†™æ³•ï¼š

```plsql
if v_val = null then
```

âœ… æ­£ç¡®å†™æ³•ï¼š

```plsql
if v_val is null then
```

ðŸ“Œ å»¶ä¼¸ï¼š

* SQL æ˜¯ä¸‰å€¼é€»è¾‘ï¼ˆTRUE / FALSE / UNKNOWNï¼‰

---

## 3. æ€§èƒ½ç›¸å…³çš„æ–°äººè¯¯åŒº

### 3.1 è®¤ä¸º BULK ä¸€å®šæ›´å¿«

âŒ è¯¯åŒºï¼š

> BULK COLLECT ä¸€å®šæ¯”æ¸¸æ ‡å¿«

âœ… å®žé™…æƒ…å†µï¼š

* å°æ•°æ®é‡ï¼šæ¸¸æ ‡æ›´ç®€å•
* å¤§æ•°æ®é‡ï¼šBULK æ˜Žæ˜¾æ›´å¿«

ðŸ“Œ å…³é”®åœ¨äºŽï¼š

> **æ•°æ®é‡ + å†…å­˜ + ä¸šåŠ¡å¤æ‚åº¦**

---

### 3.2 å¿½è§† LIMIT

âŒ é”™è¯¯ç¤ºä¾‹ï¼š

```plsql
select * bulk collect into v_rows from huge_table;
```

é£Žé™©ï¼š

* PGA å†…å­˜çˆ†ç‚¸

âœ… æ­£ç¡®åšæ³•ï¼š

* BULK + LIMIT åˆ†æ‰¹

---

## 4. PACKAGE ä½¿ç”¨æ–¹é¢çš„å¸¸è§é—®é¢˜

### 4.1 ä¸ç”¨ PACKAGEï¼Œè¿‡ç¨‹åˆ°å¤„æ•£è½

é—®é¢˜ï¼š

* æ— å‘½åç©ºé—´
* æƒé™éš¾æŽ§
* ç»´æŠ¤å›°éš¾

âœ… é¡¹ç›®åŽŸåˆ™ï¼š

> **æ ¸å¿ƒä¸šåŠ¡é€»è¾‘å¿…é¡»å°è£…åœ¨ PACKAGE ä¸­**

---

### 4.2 åœ¨ PACKAGE SPEC ä¸­æš´éœ²å¤ªå¤šä¸œè¥¿

âŒ é”™è¯¯åšæ³•ï¼š

* æŠŠæ‰€æœ‰è¿‡ç¨‹éƒ½å†™è¿› SPEC

âœ… æ­£ç¡®åšæ³•ï¼š

* SPEC åªæš´éœ²æŽ¥å£
* BODY éšè—å®žçŽ°

---

## 5. æ‰¹å¤„ç†ç›¸å…³å¸¸è§é”™è¯¯

### 5.1 æ‰¹å¤„ç†ä¸èƒ½é‡è·‘

âŒ é—®é¢˜è®¾è®¡ï¼š

* æ— çŠ¶æ€å­—æ®µ
* æ— æ‰¹æ¬¡å·

åŽæžœï¼š

* ä¸€æ—¦å¤±è´¥åªèƒ½æ‰‹å·¥ä¿®æ•°æ®

âœ… æ­£ç¡®è®¾è®¡ï¼š

* çŠ¶æ€æŽ§åˆ¶
* å¹‚ç­‰è®¾è®¡

---

### 5.2 æ²¡æœ‰æ—¥å¿—è¡¨

âŒ åªç”¨ dbms_output

é—®é¢˜ï¼š

* ç”Ÿäº§çŽ¯å¢ƒä¸å¯è§

âœ… å¿…é¡»ï¼š

* æ—¥å¿—è¡¨ + è‡ªæ²»äº‹åŠ¡

---

## 6. é¢è¯•é«˜é¢‘é—®é¢˜ï¼ˆå¸¦ç­”é¢˜æ€è·¯ï¼‰

### Q1ï¼šPL/SQL ä¸­æ¸¸æ ‡å’Œ BULK COLLECT çš„åŒºåˆ«ï¼Ÿ

ç­”é¢˜æ€è·¯ï¼š

* SQL æ‰§è¡Œæ–¹å¼ä¸€æ ·
* åŒºåˆ«åœ¨æ•°æ®è¿”å›žæ–¹å¼
* ä¸Šä¸‹æ–‡åˆ‡æ¢æ¬¡æ•°ä¸åŒ

---

### Q2ï¼šå­˜å‚¨è¿‡ç¨‹é‡Œèƒ½ä¸èƒ½ COMMITï¼Ÿ

ç­”é¢˜æ€è·¯ï¼š

* åœ¨çº¿äº‹åŠ¡ä¸å…è®¸
* æ‰¹å¤„ç†å…è®¸
* è§¦å‘å™¨ä¸å…è®¸

---

### Q3ï¼šä¸ºä»€ä¹ˆé¡¹ç›®ä¸­è¦ç”¨ PACKAGEï¼Ÿ

ç­”é¢˜æ€è·¯ï¼š

* æŽ¥å£ä¸Žå®žçŽ°åˆ†ç¦»
* æƒé™æŽ§åˆ¶
* æ€§èƒ½

---

### Q4ï¼šæ‰¹å¤„ç†å¤±è´¥äº†æ€Žä¹ˆåŠžï¼Ÿ

ç­”é¢˜æ€è·¯ï¼š

* æ”¯æŒé‡è·‘
* æ—¥å¿—å®šä½
* å¹‚ç­‰è®¾è®¡

---

### Q5ï¼šå¦‚ä½•é¿å… PL/SQL æ€§èƒ½é—®é¢˜ï¼Ÿ

å…³é”®è¯ï¼š

* å‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢
* BULK / FORALL
* åˆç† COMMIT

---

## 7. æ–°äººåˆ°ç†Ÿç»ƒå·¥ç¨‹å¸ˆçš„å…³é”®è½¬å˜

| é˜¶æ®µ | ç‰¹ç‚¹ |
| -- | ----- |
| æ–°äºº | ä¼šå†™è¯­æ³• |
| ç†Ÿç»ƒ | çŸ¥é“é£Žé™© |
| é«˜çº§ | èƒ½æå‰è§„é¿ |

---

## 8. å…¨ä¹¦æ€»ç»“ï¼ˆä¸€å¥è¯ï¼‰

> **PL/SQL ä¸æ˜¯å†™å¾—å¤šï¼Œè€Œæ˜¯å†™å¾—ç¨³ã€è·‘å¾—ä¹…ã€ä¸å‡ºäº‹ã€‚**

---

## 9. æœ¬ç«  & å…¨æ•™ç¨‹ç»“è¯­

å¦‚æžœä½ èƒ½å®Œæ•´ç†è§£å¹¶å®žè·µï¼š

* PACKAGE
* å¼‚å¸¸è®¾è®¡
* æ‰¹é‡å¤„ç†
* äº‹åŠ¡è¾¹ç•Œ

é‚£ä¹ˆä½ å·²ç»ï¼š

> âœ… ä¸æ˜¯â€œåªä¼šå†™ PL/SQL çš„æ–°äººâ€ï¼Œ
>
> è€Œæ˜¯ **èƒ½åœ¨çœŸå®žé¡¹ç›®ä¸­æ‰¿æ‹…è´£ä»»çš„å·¥ç¨‹å¸ˆ**ã€‚
